<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Asari Review Report</title>

    <!-- ================================================================================================= -->
    <!--  Styleï¼ˆã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©ï¼‰ -->
    <!--  - ã‚«ãƒ©ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³ã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã€å…±é€šUIã€‚                                                            -->
    <!--  - ãƒ€ãƒŸãƒ¼æ™‚ã«ã ã‘è¡¨ç¤ºã™ã‚‹è­¦å‘ŠãƒãƒŠãƒ¼ï¼ãƒã‚¹ã‚¯ç”¨ã®ã‚¯ãƒ©ã‚¹ã‚‚å«ã‚€ã€‚                                        -->
    <!-- ================================================================================================= -->
    <style>
      /* --- ã‚«ãƒ©ãƒ¼ & ãƒ‡ã‚¶ã‚¤ãƒ³å¤‰æ•° (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ) --- */
      :root{
        --bg:#f7f7f8; --card:#fff; --ink:#0f172a; --muted:#64748b; --bd:#e5e7eb; --accent:#2563eb;
        --bad:#b91c1c; --warn:#d97706; --ok:#16a34a;
        --blue:#3b82f6; --violet:#7e22ce; --red:#b91c1c; --yellow:#facc15; --green:#16a34a; --sky:#0ea5e9; --pink:#ec4899;
      }
      @media (prefers-color-scheme: dark) {
        :root{
          --bg:#0b0f15; --card:#0f1520; --ink:#e5e7eb; --muted:#94a3b8; --bd:#1f2937; --accent:#60a5fa;
          --bad:#ef4444; --warn:#f59e0b; --ok:#22c55e;
          --blue:#60a5fa; --violet:#a78bfa; --red:#ef4444; --yellow:#fde047; --green:#22c55e; --sky:#38bdf8; --pink:#f472b6;
        }
      }

      /* --- ãƒªã‚»ãƒƒãƒˆ / åŸºæœ¬ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ --- */
      * { box-sizing: border-box; }
      html, body { height: 100%; margin:0; font-family: system-ui, -apple-system, 'Noto Sans JP', sans-serif; background: var(--bg); color: var(--ink); }

      /* --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
      .wrap { max-width:1160px; margin:24px auto 80px; padding:0 16px; }
      .card { background:var(--card); border:1px solid var(--bd); border-radius:16px; padding:18px; }
      .header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
      .brand .title { font-weight:700; }
      .meta { color:var(--muted); font-size:12px; }
      .btn { border:1px solid var(--bd); background:transparent; border-radius:10px; padding:8px 12px; cursor:pointer; }
      .btn.primary { background:var(--accent); color:#fff; border-color:transparent; }
      .grid { display:grid; grid-template-columns:1.4fr .9fr; gap:16px; }
      @media (max-width:980px){ .grid{grid-template-columns:1fr;} }
      .sticky{position:sticky; top:16px;}

      /* --- å°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ --- */
      .chips{display:flex; flex-wrap:wrap; gap:8px;}
      .chip{display:inline-flex; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--bd); font-size:12px;}
      .alert{border-left:6px solid var(--bad); background:color-mix(in oklab,var(--red) 18%,#0000); padding:12px; border-radius:12px;}

      /* --- ã‚»ã‚¯ã‚·ãƒ§ãƒ³ / ã‚«ãƒ¼ãƒ‰ --- */
      .section{display:grid; grid-template-columns:1fr 1fr; gap:16px;}
      @media (max-width:980px){.section{grid-template-columns:1fr;}}
      .review-card{border-radius:16px; padding:16px 16px 10px; border:1px solid var(--bd); background:var(--card);}
      .review-card header{display:flex; align-items:center; gap:10px; margin-bottom:8px;}
      .review-card header h3{margin:0; font-size:15px;}
      .icon{font-size:18px;}

      /* ã‚«ãƒ†ã‚´ãƒªè‰²ï¼ˆå·¦ãƒœãƒ¼ãƒ€ãƒ¼ï¼‹æ·¡èƒŒæ™¯ï¼‰ */
      .typo{--bgc:color-mix(in oklab,var(--blue)10%,#0000); --bar:var(--blue);}
      .policy{--bgc:color-mix(in oklab,var(--violet)10%,#0000); --bar:var(--violet);}
      .risk{--bgc:color-mix(in oklab,var(--red)10%,#0000); --bar:var(--red);}
      .youtube{--bgc:color-mix(in oklab,var(--yellow)16%,#0000); --bar:var(--yellow);}
      .asari{--bgc:color-mix(in oklab,var(--green)12%,#0000); --bar:var(--green);}
      .readab{--bgc:color-mix(in oklab,var(--sky)10%,#0000); --bar:var(--sky);}
      .begin{--bgc:color-mix(in oklab,var(--pink)10%,#0000); --bar:var(--pink);}
      .review-card{background:linear-gradient(0deg,var(--bgc),var(--bgc)),var(--card); border-left:6px solid var(--bar);}

      .issues{display:grid; gap:8px;}
      .issue{border:1px dashed var(--bd); border-radius:12px; padding:10px;}
      .issue .t{font-weight:600;}
      .issue .s{color:var(--muted); margin-top:4px;}

      /* --- ãƒãƒƒã‚¸ / é‡å¤§åº¦è¡¨ç¤º --- */
      .badge{font-size:11px; border-radius:6px; padding:3px 6px; border:1px solid var(--bd); color:var(--muted);}
      .sev-high{border-color:color-mix(in oklab,var(--bad)40%,var(--bd)); color:var(--bad);}
      .sev-med{border-color:color-mix(in oklab,var(--warn)40%,var(--bd)); color:var(--warn);}
      .sev-low{border-color:color-mix(in oklab,var(--ok)40%,var(--bd)); color:var(--ok);}
      .sev-info{border-color:var(--bd); color:var(--muted);}

      .side .hint{color:var(--muted); font-size:12px; margin:6px 0 10px;}
      .sugg{border:1px dashed var(--bd); border-radius:12px; padding:10px; margin:10px 0;}
      .sugg label{font-size:12px; color:var(--muted);}
      .sugg details{margin-top:6px;}

      /* --- ãƒ€ãƒŸãƒ¼æ¤œçŸ¥æ™‚ã®UI --- */
      .dummy-banner{
        position: sticky; top: 0; z-index: 1000;
        display:flex; align-items:center; gap:10px;
        padding:10px 14px; margin:0 0 12px 0;
        background: color-mix(in oklab, var(--red) 25%, #fff);
        color:#fff; border-bottom:2px solid var(--bad);
        font-weight:700;
      }
      .dummy-mask{
        position: fixed; inset: 0; pointer-events:none;
        background-image: repeating-linear-gradient(
          -45deg,
          rgba(185,28,28,.08) 0px, rgba(185,28,28,.08) 12px,
          rgba(185,28,28,0) 12px, rgba(185,28,28,0) 24px
        );
        z-index: 500;
      }
      .dummy-dim{ opacity:.35; filter:grayscale(.25); }
      .disabled { pointer-events:none; opacity:.6; }
    </style>
  </head>

  <body>
    <div class="wrap" id="rootWrap">
      <!-- Header -->
      <div class="card header">
        <div class="brand">
          <div>
            <div class="title">Asari Review Report</div>
            <div class="meta">ãƒ¬ãƒ“ãƒ¥ãƒ¼æ—¥æ™‚ï¼š<span id="revAt">-</span></div>
          </div>
        </div>
        <div>
          <button class="btn" id="expandAll">ã™ã¹ã¦å±•é–‹</button>
          <button class="btn" id="collapseAll">ã™ã¹ã¦æŠ˜ã‚ŠãŸãŸã¿</button>
          <button class="btn primary" id="downloadPatch">ãƒ‘ãƒƒãƒJSONã‚’DL</button>
        </div>
      </div>

      <!-- Summary -->
      <div class="card" id="summaryCard" style="margin:16px 0">
        <div style="font-weight:700; margin-bottom:6px">æ¦‚è¦</div>
        <div id="summaryText" class="meta" style="line-height:1.7"></div>

        <div class="chips" style="margin-top:10px">
          <span class="chip">æ­£ç¢ºæ€§ <b id="sc-acc">-</b>/10</span>
          <span class="chip">åˆå¿ƒè€… <b id="sc-beg">-</b>/10</span>
          <span class="chip">ãƒˆãƒ¼ãƒ³ <b id="sc-ton">-</b>/10</span>
          <span class="chip">æ§‹æˆ <b id="sc-str">-</b>/10</span>
          <span class="chip">CTA <b id="sc-cta">-</b>/10</span>
          <span class="chip">ãƒªã‚¹ã‚¯ <b id="sc-rsk">-</b>/10</span>
          <span class="chip">ç·åˆ <b id="sc-all">-</b>/10</span>
        </div>

        <div id="riskAlert" class="alert" style="display:none; margin-top:12px">
          âš ï¸ é«˜é‡å¤§åº¦ï¼ˆHIGHï¼‰ã®ç‚ä¸Šãƒªã‚¹ã‚¯ãŒæ¤œå‡ºã•ã‚Œã¦ã„ã¾ã™ã€‚å…ˆã«æœ¬ã‚«ãƒ¼ãƒ‰ã®å¯¾å¿œã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚
        </div>
      </div>

      <div class="grid">
        <!-- Main: Category Cards -->
        <main class="section" id="cards"></main>

        <!-- Side: Asari style suggestions -->
        <aside class="side">
          <div class="card sticky">
            <div style="font-weight:700">Asariã‚‰ã—ã•ï¼šè¿½åŠ ææ¡ˆ</div>
            <div class="hint">æ¡ç”¨ã«ãƒã‚§ãƒƒã‚¯ â†’ å³ä¸Šãƒœã‚¿ãƒ³ã§DL</div>
            <div id="suggestList"></div>
          </div>
        </aside>
      </div>
    </div>

    <!-- =================================================================== -->
    <!--  å®Ÿãƒ‡ãƒ¼ã‚¿æ³¨å…¥ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬å†…ã®æœ€ä¸Šæµã«ç½®ãï¼‰                   -->
    <!--  â€» ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ãŒ Dummy åˆæœŸå€¤ <script> ã‚ˆã‚Šå‰ã«æ¥ã‚‹ã“ã¨ãŒå¿…é ˆ     -->
    <!--  â€» ChatGPTãŒä¸€ç™ºå‡ºåŠ›ã™ã‚‹éš›ã¯ã€ã“ã®ä¸­èº«ã‚’ãƒ¢ãƒ‡ãƒ«ãŒå®Ÿãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ã   -->
    <!-- =================================================================== -->
    <script id="__ASARI_DATA__">
      // 1) ãƒ€ãƒŸãƒ¼ç„¡åŠ¹åŒ–ï¼ˆé‡è¦ï¼šguardDummyã«ã‚ˆã‚‹ãƒ€ãƒŸãƒ¼UIæŠ‘æ­¢ï¼‰
      window.__ASARI_DUMMY = false;

      // 2) REVIEW_SUMMARYï¼ˆä¾‹ï¼šå®Ÿé‹ç”¨ã§ã¯ãƒ¢ãƒ‡ãƒ«ãŒç”Ÿæˆï¼‰
      window.REVIEW_SUMMARY = {
        reviewedAt: "2025-11-02T14:05:00+09:00",
        summary: "å°å…¥ã®è‡ªç„¶ã•ã¨CTAãŒå¼·ã¿ã€‚æ„Ÿå˜†ç¬¦ã®é »åº¦ã‚’æŠ‘ãˆã‚‹ã¨ãƒˆãƒ¼ãƒ³ãŒå®‰å®šã—ã¾ã™ã€‚",
        scores: { accuracy: 9, accessibility: 8, tone: 8, structure: 9, cta: 10, risk: 10, overall: 9 }
      };

      // 3) REVIEW_ISSUESï¼ˆä¾‹ï¼‰
      window.REVIEW_ISSUES = [
        {
          category: "readability",
          severity: "low",
          text: "ä¸€éƒ¨ã®æ–‡ãŒé•·ã„ï¼ˆèª­ç‚¹3ã¤ä»¥ä¸Šï¼‰ã€‚èãå–ã‚Šã‚’æƒ³å®šã—åŒºåˆ‡ã‚‹ã¨ãƒ†ãƒ³ãƒãŒæ”¹å–„ã€‚",
          suggestion: "2æ–‡ã«åˆ†å‰²ã—ã€ä¸»èªâ†’çµè«–â†’è£œè¶³ã®é †ã«æ•´åˆ—ã€‚",
          details: { line: 12, sentence_length: 55, comma_count: 4, rule: "å¹³å‡æ–‡é•·>42" }
        }
      ];

      // 4) STYLE_SUGGESTIONSï¼ˆä¾‹ï¼šãƒã‚§ãƒƒã‚¯â†’å³ä¸Šãƒœã‚¿ãƒ³ã§patchå‡ºåŠ›ï¼‰
      window.STYLE_SUGGESTIONS = [
        {
          id: "a1",
          type: "phrasing",
          purpose: "æ„Ÿå˜†ç¬¦ã®é »åº¦æœ€é©åŒ–",
          recommendation: "å¼·èª¿ã¯1æ–‡ã‚ãŸã‚Šæœ€å¤§1å›ã«åˆ¶é™ã€‚",
          impact_scope: "stylebook.json",
          evidence: [{ snippet: "ã‚„ã‚Šã¦ã‡ï¼ï¼", line: 1 }],
          patches: [
            { target: "stylebook.json", ops: [ { op: "add", path: "/rules/-", value: "æ„Ÿå˜†ç¬¦ã¯1æ–‡1å›ã¾ã§" } ] }
          ]
        }
      ];
    </script>

    <!-- ================================================================================================= -->
    <!--  Dummy åˆæœŸå€¤ï¼ˆä¸Šè¨˜ __ASARI_DATA__ ã§ä¸Šæ›¸ãã•ã‚Œãªã‘ã‚Œã°ãƒ€ãƒŸãƒ¼åˆ¤å®šã¸ï¼‰                               -->
    <!--  - __dummy: true ãƒ•ãƒ©ã‚°ã§ guardDummy ãŒæ¤œå‡ºã€‚                                                       -->
    <!-- ================================================================================================= -->
    <script>
      // ãƒ€ãƒŸãƒ¼ãƒ•ãƒ©ã‚°ï¼ˆæœªä¸Šæ›¸ãæ¤œçŸ¥ç”¨ï¼‰
      window.__ASARI_DUMMY = window.__ASARI_DUMMY ?? true;

      // REVIEW_SUMMARYï¼ˆãƒ€ãƒŸãƒ¼ï¼‰
      window.REVIEW_SUMMARY = window.REVIEW_SUMMARY || {
        __dummy: true,
        reviewedAt: "DUMMY",
        summary: "ã€ãƒ€ãƒŸãƒ¼ã€‘å®Ÿãƒ‡ãƒ¼ã‚¿ãŒæœªæ³¨å…¥ã§ã™ã€‚ãƒ†ãƒ³ãƒ—ãƒ¬ä¸Šéƒ¨ã« __ASARI_DATA__ ãƒ–ãƒ­ãƒƒã‚¯ã‚’æŒ¿å…¥ã—ã¦ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚",
        scores: { accuracy: "-", accessibility: "-", tone: "-", structure: "-", cta: "-", risk: "-", overall: "-" }
      };

      // REVIEW_ISSUESï¼ˆãƒ€ãƒŸãƒ¼ï¼‰
      window.REVIEW_ISSUES = window.REVIEW_ISSUES || [
        {
          category: "system",
          severity: "info",
          text: "ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«å®Ÿãƒ‡ãƒ¼ã‚¿ãŒæ³¨å…¥ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚",
          suggestion: "ä¸Šéƒ¨ã«å®Ÿãƒ‡ãƒ¼ã‚¿ã® <script id=\"__ASARI_DATA__\"> ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ ã—ã¦å†å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚"
        }
      ];

      // STYLE_SUGGESTIONSï¼ˆãƒ€ãƒŸãƒ¼ï¼‰
      window.STYLE_SUGGESTIONS = window.STYLE_SUGGESTIONS || [];
    </script>

    <!-- ================================================================================================= -->
    <!--  Main Scriptï¼ˆæç”»ãƒ­ã‚¸ãƒƒã‚¯ï¼‰                                                                       -->
    <!--  - å…ˆé ­ã§ãƒ€ãƒŸãƒ¼æ¤œçŸ¥ã€‚ãƒ€ãƒŸãƒ¼ãªã‚‰ãƒãƒŠãƒ¼è¡¨ç¤ºï¼‹UIã‚’åŠé€æ˜ï¼†æ“ä½œä¸å¯ã«ã—ã¦æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ã¯ã—ãªã„ï¼ˆç¢ºèªç”¨ï¼‰ã€‚ -->
    <!--  - å®Ÿãƒ‡ãƒ¼ã‚¿ã«ä¸Šæ›¸ãã•ã‚Œã¦ã„ã‚Œã°é€šå¸¸ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¸ã€‚                                                 -->
    <!-- ================================================================================================= -->
    <script>
      // DOMãƒ˜ãƒ«ãƒ‘ãƒ¼
      const $  = (s, el = document) => el.querySelector(s);
      const $$ = (s, el = document) => Array.from(el.querySelectorAll(s));

      // --- 0) ãƒ€ãƒŸãƒ¼æ¤œçŸ¥ï¼†ãƒãƒŠãƒ¼è¡¨ç¤ºï¼ˆæœ€åˆã«å®Ÿè¡Œï¼‰ ---
      (function guardDummy(){
        const isDummy = !!(window.__ASARI_DUMMY || window.REVIEW_SUMMARY?.__dummy);
        if(!isDummy) return; // å®Ÿãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãæ¸ˆã¿ â†’ é€šå¸¸æç”»ã¸

        // ãƒãƒŠãƒ¼ï¼ˆèµ¤ï¼‰ï¼‹å…¨é¢ã®ãƒã‚¹ã‚¯
        document.body.insertAdjacentHTML('afterbegin',
          `<div class="dummy-banner">ğŸš¨ ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã§è¡¨ç¤ºä¸­ï¼š__ASARI_DATA__ ãŒæ³¨å…¥ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>`
        );
        const mask = document.createElement('div');
        mask.className = 'dummy-mask';
        document.body.appendChild(mask);

        // ãƒ¡ã‚¤ãƒ³UIã‚’åŠé€æ˜ï¼†æ“ä½œä¸å¯ã«
        const root = $('#rootWrap');
        if(root) root.classList.add('dummy-dim');
        $$('#downloadPatch, #expandAll, #collapseAll').forEach(b => b?.classList.add('disabled'));

        // ãƒ€ãƒŸãƒ¼ã§ã‚‚ã€Œä½•ãŒè¶³ã‚Šãªã„ã‹ã€ã¯ç¢ºèªã§ãã‚‹ã‚ˆã†ã€ä»¥é™ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¯å®Ÿè¡Œã™ã‚‹
      })();

      // --- 1) ãƒ˜ãƒƒãƒ€ã¨ã‚¹ã‚³ã‚¢åˆæœŸåŒ– ---
      (function initSummary(){
        const s  = window.REVIEW_SUMMARY || {};
        const sc = s.scores || {};
        // æ—¥æ™‚è¡¨ç¤ºï¼ˆãƒ€ãƒŸãƒ¼ã¯ãã®ã¾ã¾ "DUMMY" ã‚’è¡¨ç¤ºã—ã¦æ°—ã¥ã‘ã‚‹ã‚ˆã†ã«ï¼‰
        $('#revAt').textContent   = String(s.reviewedAt ?? '');
        $('#summaryText').textContent = s.summary ?? '';

        $('#sc-acc').textContent = sc.accuracy      ?? '-';
        $('#sc-beg').textContent = sc.accessibility ?? '-';
        $('#sc-ton').textContent = sc.tone          ?? '-';
        $('#sc-str').textContent = sc.structure     ?? '-';
        $('#sc-cta').textContent = sc.cta           ?? '-';
        $('#sc-rsk').textContent = sc.risk          ?? '-';
        $('#sc-all').textContent = sc.overall       ?? '-';
      })();

      // --- 2) ä»£è¡¨ãƒ¬ãƒ™ãƒ«ç®—å‡º ---
      function computeCategorySeverity(list){
        if(!list || !list.length) return 'info';
        const rank = { high:3, medium:2, low:1 };
        let max = 0;
        for(const i of list){
          const sev = String(i.severity || '').toLowerCase();
          max = Math.max(max, rank[sev] || 0);
        }
        return max===3 ? 'high' : max===2 ? 'medium' : max===1 ? 'low' : 'info';
      }

      // --- 3) æŒ‡æ‘˜ãªã—æ™‚ã®ãƒã‚¸ãƒ†ã‚£ãƒ–æ–‡è¨€ ---
      function getPositiveMessage(key){
        const m = {
          typo_card:        "è¡¨è¨˜æºã‚Œãƒ»èª¤å­—è„±å­—ã¯ç¢ºèªã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚",
          policy_card:      "è¦ç´„ãƒ»ãƒãƒªã‚·ãƒ¼é•åã¯ã‚ã‚Šã¾ã›ã‚“ã€‚",
          risk_card:        "ç‚ä¸Šãƒªã‚¹ã‚¯ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚",
          youtube_card:     "æ§‹æˆã¨CTAã¯è‡ªç„¶ã§æ¨å¥¨æ§‹æˆã«æº–æ‹ ã—ã¦ã„ã¾ã™ã€‚",
          asari_card:       "â€œã‚¢ã‚µãƒªã‚‰ã—ã•â€ã®ãƒˆãƒ¼ãƒ³ã«åˆè‡´ã—ã¦ã„ã¾ã™ã€‚",
          readability_card: "æ–‡ã®åŒºåˆ‡ã‚Šã¨èªå½™é¸æŠã¯æ¨™æº–ã«æ²¿ã£ã¦ã„ã¾ã™ã€‚",
          beginner_card:    "åˆå¿ƒè€…å‘ã‘è£œè¶³ãŒé©åˆ‡ã§ã™ã€‚"
        };
        return m[key] || "è‰¯å¥½ã§ã™ã€‚";
      }

      // --- 4) Issue æç”»ã®HTMLæ–­ç‰‡ä½œæˆ ---
      function renderIssueHTML(i){
        const t=i.text||''; const s=i.suggestion||''; const d=i.details||null;
        if(!d) return `<div class="t">${t}</div><div class="s">ææ¡ˆï¼š${s||'-'}</div>`;
        return `
          <div class="t">${t}</div>
          <ul class="meta" style="margin:6px 0 0 0;padding-left:18px;line-height:1.6">
            ${d.line?`<li>ä½ç½®ï¼šL${d.line}</li>`:''}
            ${d.sentence_length?`<li>æ–‡é•·ï¼š${d.sentence_length}æ–‡å­—</li>`:''}
            ${d.comma_count?`<li>èª­ç‚¹ï¼š${d.comma_count}å€‹</li>`:''}
            ${d.rule?`<li>ãƒ«ãƒ¼ãƒ«ï¼š${d.rule}</li>`:''}
          </ul>
          ${d.snippet?`<div class="meta" style="margin-top:6px">è©²å½“ï¼š</div><pre>${d.snippet}</pre>`:''}
          ${d.fix?`<div class="meta" style="margin-top:6px">ä¿®æ­£ä¾‹ï¼š</div><pre>${d.fix}</pre>`:''}
          ${s?`<div class="s" style="margin-top:6px">ææ¡ˆï¼š${s}</div>`:''}`;
      }

      // --- 5) ã‚«ãƒ¼ãƒ‰æç”» ---
      (function renderCards(){
        const container = $('#cards');
        const issues = (window.REVIEW_ISSUES || []).slice();

        // é«˜é‡å¤§åº¦ï¼ˆHIGHï¼‰ã®ãƒªã‚¹ã‚¯ãŒã‚ã‚Œã°è­¦å‘Šè¡¨ç¤º
        const hasHighRisk = issues.some(i => i.category==='risk_tone' && (i.severity||'').toLowerCase()==='high');
        if(hasHighRisk) $('#riskAlert').style.display = 'block';

        const mapCategoryToCard = {
          "style_consistency": "typo_card",
          "review_policy":     "policy_card",
          "risk_tone":         "risk_card",
          "youtube_logic":     "youtube_card",
          "style_guideline":   "asari_card",
          "readability":       "readability_card",
          "beginner_fit":      "beginner_card"
        };

        const cardDefs = {
          typo_card:        { cls:'typo',    title:'ğŸ“ èª¤å­—è„±å­—ãƒ»è¡¨è¨˜ã‚†ã‚Œ', icon:'âœï¸' },
          policy_card:      { cls:'policy',  title:'âš–ï¸ è¦ç´„é•å',         icon:'âš–ï¸' },
          risk_card:        { cls:'risk',    title:'ğŸ”¥ ç‚ä¸Šãƒªã‚¹ã‚¯',       icon:'ğŸ”¥' },
          youtube_card:     { cls:'youtube', title:'ğŸ¯ YouTubeé‹ç”¨',      icon:'ğŸ¯' },
          asari_card:       { cls:'asari',   title:'ğŸŒ¿ ã‚¢ã‚µãƒªã‚‰ã—ã•',     icon:'ğŸŒ¿' },
          readability_card: { cls:'readab',  title:'ğŸ“– å¯èª­æ€§',            icon:'ğŸ“–' },
          beginner_card:    { cls:'begin',   title:'ğŸ“ åˆå¿ƒè€…å‘ã‘è£œè¶³',    icon:'ğŸ“' }
        };

        // ãƒã‚±ãƒƒãƒˆåŒ–
        const buckets = {};
        for(const it of issues){
          const key = mapCategoryToCard[it.category] || 'readability_card';
          (buckets[key] ||= []).push(it);
        }

        const order = ['risk_card','policy_card','typo_card','readability_card','beginner_card','youtube_card','asari_card'];

        order.forEach(cardKey=>{
          const list = buckets[cardKey] || [];
          const def  = cardDefs[cardKey];
          const topSeverity = computeCategorySeverity(list);

          const card = document.createElement('section');
          card.className = `review-card ${def.cls}`;

          const sevLabel = {high:'HIGH', medium:'MEDIUM', low:'LOW', info:'INFO'}[topSeverity];
          const sevClass = {high:'sev-high', medium:'sev-med', low:'sev-low', info:'sev-info'}[topSeverity];

          card.innerHTML = `
            <header>
              <span class="icon">${def.icon}</span>
              <h3>${def.title} <span class="badge ${sevClass}">${sevLabel}</span></h3>
            </header>
            <div class="issues"></div>
          `;
          const wrap = card.querySelector('.issues');

          if(list.length === 0){
            // æŒ‡æ‘˜ãªã— â†’ INFOã¨ã—ã¦è‚¯å®šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            const dv = document.createElement('div');
            dv.className = 'issue';
            dv.innerHTML = `<div class="t">${getPositiveMessage(cardKey)}</div>`;
            wrap.appendChild(dv);
          } else {
            // æŒ‡æ‘˜ã‚ã‚Š â†’ è©³ç´°ã‚’æç”»
            const sevRank = { high:0, medium:1, low:2 };
            list.sort((a,b)=>{
              const sa = sevRank[(a.severity||'').toLowerCase()] ?? 9;
              const sb = sevRank[(b.severity||'').toLowerCase()] ?? 9;
              if(sa!==sb) return sa-sb;
              return String(a.text||'').localeCompare(String(b.text||''),'ja');
            });
            list.forEach(i=>{
              const sev = (i.severity||'info').toLowerCase();
              const sevCls = {high:'sev-high',medium:'sev-med',low:'sev-low',info:'sev-info'}[sev];
              const dv = document.createElement('div');
              dv.className = 'issue';
              dv.innerHTML = `${renderIssueHTML(i)}<div style="margin-top:6px"><span class="badge ${sevCls}">${sev.toUpperCase()}</span></div>`;
              wrap.appendChild(dv);
            });
          }
          container.appendChild(card);
        });
      })();

      // --- 6) Controls ---
      $('#expandAll').onclick   = () => $$('details').forEach(d => d.open = true);
      $('#collapseAll').onclick = () => $$('details').forEach(d => d.open = false);

      const approved = new Set(); // æ¡ç”¨ã‚µã‚¸ã‚§ã‚¹ãƒˆ

      // --- 7) Download Patchï¼ˆæ¡ç”¨ã—ãŸææ¡ˆã‚’æŸã­ã¦JSONå‡ºåŠ›ï¼‰ ---
      $('#downloadPatch').onclick = () => {
        const chosen = (window.STYLE_SUGGESTIONS || []).filter(s => approved.has(s.id));
        const bundle = {};
        chosen.forEach(s => (s.patches || []).forEach(p => {
          (bundle[p.target] ??= []).push(...(p.ops || []));
        }));
        const blob = new Blob([JSON.stringify(bundle, null, 2)], { type:'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'style-patch.json';
        a.click();
        URL.revokeObjectURL(a.href);
      };

      // --- 8) ã‚¹ã‚¿ã‚¤ãƒ«ææ¡ˆã®æç”» ---
      (function renderSuggestions(){
        const listEl = $('#suggestList');
        const arr = (window.STYLE_SUGGESTIONS || []);
        if(!arr.length){
          listEl.innerHTML = '<div class="meta">ä»Šå›ã¯è¿½åŠ ææ¡ˆãªã—ã€‚</div>';
          return;
        }
        arr.forEach(s=>{
          const box = document.createElement('div');
          box.className = 'sugg';
          const ev = (s.evidence||[]).map(e=>`ã€Œ${e.snippet}ã€(L${e.line??'-'})`).join(' / ');
          box.innerHTML = `
            <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
              <div><b>[${s.type||'general'}] ${s.purpose||''}</b></div>
              <label><input type="checkbox" data-id="${s.id}"> æ¡ç”¨</label>
            </div>
            <div class="meta" style="margin-top:6px">${s.recommendation||''}</div>
            <details style="margin-top:6px">
              <summary>æ ¹æ‹ ãƒ»ãƒ‘ãƒƒãƒ</summary>
              <div class="meta" style="margin:6px 0">${ev||'-'}</div>
              <pre style="white-space:pre-wrap">${JSON.stringify(s.patches||[], null, 2)}</pre>
            </details>
          `;
          listEl.appendChild(box);
          box.querySelector('input').onchange = e => {
            e.target.checked ? approved.add(s.id) : approved.delete(s.id);
          };
        });
      })();
    </script>
  </body>
</html>
