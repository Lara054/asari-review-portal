<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SHELL'S VALORANT æ’®å½±æŒ‡ç¤ºæ›¸</title>
  <style>
    :root {
      --bg:#0b0f14;
      --panel:#121826;
      --panel2:#0f1522;
      --text:#e6edf3;
      --muted:#9aa4b2;
      --line:rgba(255,255,255,.08);
      --ok:#2ea043;
      --ng:#f85149;
      --warn:#d29922;
      --chip:rgba(255,255,255,.06);
      --shadow:0 12px 40px rgba(0,0,0,.35);
      --radius:14px;
      --highlight:#58a6ff;
      --highlight-bg:rgba(0,102,255,.08);
      --highlight-border:rgba(0,102,255,.3);
    }
    html,body{height:100%;}
    body {
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      line-height:1.45;
    }
    .wrap{max-width:1320px;margin:0 auto;padding:14px;}
    .topbar {
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      border:1px solid var(--line); border-radius:var(--radius); padding:12px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(6px);
    }
    .title{font-weight:900;font-size:14px; letter-spacing:.01em;}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:rgba(255,255,255,.04);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px;}
    .dot{width:9px;height:9px;border-radius:99px;background:var(--muted);display:inline-block;}
    .dot.ok{background:var(--ok);} .dot.ng{background:var(--ng);} .dot.warn{background:var(--warn);}
    button {
      background:rgba(255,255,255,.06);
      color:var(--text);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
    }
    button:hover{background:rgba(255,255,255,.09);}
    button:disabled{opacity:.55;cursor:not-allowed;}
    .ghost{background:transparent;}
    .danger{border-color:rgba(248,81,73,.35);}
    input[type="file"]{color:var(--muted);}
    .layout{display:grid;grid-template-columns:360px 1fr;gap:12px;margin-top:12px;}
    @media (max-width:1050px){.layout{grid-template-columns:1fr;} .topbar{position:static;}}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow);}
    .card h2{margin:0 0 10px 0;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;}
    label{font-size:12px;color:var(--muted);font-weight:900;display:flex;flex-direction:column;gap:6px;}
    select,input[type="text"],textarea {
      background:var(--panel2); color:var(--text); border:1px solid var(--line);
      border-radius:12px; padding:10px 10px; outline:none; font-weight:800; box-sizing:border-box;
    }
    textarea {
      font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:12px; font-weight:700; line-height:1.35; resize:vertical; min-height:86px; width:100%;
    }
    .meta{display:grid;grid-template-columns:1fr;gap:10px;}
    .hint{font-size:12px;color:var(--muted);}
    .metaStatus{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:10px;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
    .list{display:flex;flex-direction:column;gap:8px;}
    .listItem {
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      border:1px solid var(--line); border-radius:12px; padding:10px;
      background:rgba(255,255,255,.02);
      cursor:grab;
      user-select:none;
    }
    .listItem:active{cursor:grabbing;}
    .listLeft{display:flex;flex-direction:column;gap:2px;min-width:0;}
    .listTop{display:flex;gap:8px;align-items:center;}
    .badge{font-size:11px;font-weight:900;background:var(--chip);border:1px solid var(--line);padding:3px 8px;border-radius:999px;color:var(--muted);}
    .badge.ok{color:var(--ok);border-color:rgba(46,160,67,.35);}
    .badge.ng{color:var(--ng);border-color:rgba(248,81,73,.35);}
    .badge.warn{color:var(--warn);border-color:rgba(210,153,34,.35);}
    .listTitle{font-weight:900;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px;}
    .listSub{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px;}
    .listRight{display:flex;gap:6px;align-items:center;}
    .iconbtn{padding:8px 10px;font-size:12px;border-radius:10px;}
    .blocks{display:flex;flex-direction:column;gap:12px;}
    .block {
      background:rgba(255,255,255,.02);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:12px;
      scroll-margin-top:90px;
    }
    .blockHead{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px;}
    .blockTitle{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .idx{font-weight:900;font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid var(--line);}
    .dirty{font-size:12px;color:var(--warn);font-weight:900;}
    .stamp{font-size:12px;color:var(--muted);}
    .cols{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width:980px){.cols{grid-template-columns:1fr;}}
    .locRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .locRow input{flex:1;min-width:220px;}
    .divider{height:1px;background:var(--line);margin:10px 0;}
    .footerActions{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;margin-top:12px;}
    .big{padding:12px 14px;border-radius:14px;}
    dialog {
      border:none; border-radius:16px; padding:0;
      background:var(--panel); color:var(--text);
      width:min(900px, 92vw);
      box-shadow:var(--shadow);
    }
    dialog::backdrop{background:rgba(0,0,0,.55);}
    .modalHead{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:12px;border-bottom:1px solid var(--line);}
    .modalBody{padding:12px;}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width:900px){.grid2{grid-template-columns:1fr;}}
    .calloutList{max-height:52vh;overflow:auto;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.02);}
    .calloutItem{padding:10px;border-bottom:1px solid var(--line);cursor:pointer;font-weight:900;}
    .calloutItem:hover{background:rgba(255,255,255,.06);}
    .calloutItem:last-child{border-bottom:none;}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;background:rgba(255,255,255,.06);border:1px solid var(--line);border-radius:8px;padding:2px 6px;color:var(--text);}
  
    .invalidBlock{border-color:rgba(248,81,73,.35)!important;}
    .invalidInput{border-color:rgba(248,81,73,.35)!important;}
    .mapFixBar{display:none;margin-top:10px;padding:10px;border:1px solid rgba(248,81,73,.25);border-radius:12px;background:rgba(248,81,73,.06);}
    .mapFixBar .row{justify-content:space-between;}
    .mapFixBar .msg{font-weight:900;font-size:12px;color:var(--text);}

    /* æ’®å½±å ´æ‰€ã‚’ç›®ç«‹ãŸã›ã‚‹ */
    .locationBox{
      background:var(--highlight-bg);
      border:2px solid var(--highlight-border);
      border-radius:12px;
      padding:12px;
      margin-top:10px;
    }
    .locationBox label{
      font-size:13px;
      font-weight:900;
      color:var(--highlight);
    }
    .locationBox input{
      border-color:var(--highlight-border)!important;
      background:rgba(0,0,0,.3);
    }
    .locationBox .locRow button{
      background:var(--highlight-bg);
      border-color:var(--highlight-border);
      color:var(--highlight);
      font-weight:900;
    }
    .locationBox .locRow button:hover{
      background:rgba(0,102,255,.15);
    }

  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="row">
      <div class="title">SHELL'S VALORANT æ’®å½±æŒ‡ç¤ºæ›¸</div>
      <span class="pill"><span id="dot" class="dot"></span><span id="statusText">-</span></span>
      <span class="pill">cards: <span id="cardCount">0</span></span>
    </div>
    <div class="row">
      <input id="importFile" type="file" accept=".json,application/json" />
      <button id="btnImport" type="button">èª­è¾¼</button>
      <button id="btnValidate" type="button">æ¤œè¨¼</button>
      <button id="btnExport" type="button">JSONå‡ºåŠ›</button>
      <button id="btnCopy" type="button">ã‚³ãƒ”ãƒ¼</button>
      <button id="btnPaste" type="button" class="ghost">è²¼ã‚Šä»˜ã‘èª­è¾¼</button>
      <button id="btnClear" type="button" class="danger">ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤</button>
    </div>
  </div>

  <div class="layout">
    <div class="leftCol">
      <div class="card">
        <h2>Meta</h2>
        <div class="meta">
          <label>Title
            <input id="metaTitle" type="text" placeholder="ä¾‹ï¼šHaven_ãƒªãƒ­ãƒ¼ãƒ‰åˆ¤æ–­" />
          </label>

          <label>Format
            <input id="metaFormat" type="text" placeholder="short / long" />
          </label>

          <label>Map
            <select id="metaMap"></select>
          </label>

          <div class="metaStatus">
            <span class="pill">resolved: <span id="mapResolved" class="mono">-</span></span>
            <span class="pill">created: <span id="metaCreatedAt" class="mono">-</span></span>
          </div>
          <div id="mapFixBar" class="mapFixBar">
            <div class="row">
              <div class="msg">æ’®å½±å ´æ‰€ ä¸ä¸€è‡´: <span id="mapFixCount" class="mono">0</span></div>
              <div class="row">
                <button id="btnFixClearInvalid" type="button" class="ghost">ä¸€æ‹¬ã‚¯ãƒªã‚¢</button>
                <button id="btnFixJumpInvalid" type="button">å…ˆé ­ã¸</button>
              </div>
            </div>
          </div>

</div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h2>Card Listï¼ˆãƒ‰ãƒ©ãƒƒã‚°ã§é †åºå¤‰æ›´ï¼‰</h2>
        <div id="cardList" class="list"></div>
        <div class="footerActions">
          <button id="btnAddLeft" type="button" class="big">ã‚«ãƒ¼ãƒ‰è¿½åŠ </button>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h2>Validation</h2>
        <div class="hint" id="validationSummary">-</div>
        <div class="divider"></div>
        <div id="validationDetails" class="hint"></div>
        <div class="divider"></div>
</div>
    </div>

    <div class="rightCol">
      <div class="card">
        <h2>Cardsï¼ˆå°æœ¬ / å‰æ / å‹•ãæ–¹ / æ’®å½±å ´æ‰€ï¼‰</h2>
        <div id="blocks" class="blocks"></div>
        <div class="footerActions">
          <button id="btnAddBottom" type="button" class="big">ã‚«ãƒ¼ãƒ‰è¿½åŠ </button>
          <button id="btnSaveAll" type="button" class="big">å…¨ä½“ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>
</div>

<dialog id="calloutModal">
  <div class="modalHead">
    <div class="row">
      <div style="font-weight:900;">æ’®å½±å ´æ‰€ï¼ˆcalloutsï¼‰ã‚’é¸æŠ</div>
      <span class="pill">map: <span id="modalMap" class="mono">-</span></span>
      <span class="pill">count: <span id="modalCount" class="mono">0</span></span>
    </div>
    <div class="row">
      <button id="btnModalClose" type="button" class="ghost">é–‰ã˜ã‚‹</button>
    </div>
  </div>
  <div class="modalBody">
    <div class="grid2">
      <div>
        <label>æ¤œç´¢
          <input id="calloutSearch" type="text" placeholder="ä¾‹ï¼šA ãƒ­ãƒ³ã‚° / ã‚¬ãƒ¬ãƒ¼ã‚¸ / CT ãªã©" />
        </label>
</div>
      <div>
        <label>ç¾åœ¨ã®å…¥åŠ›ï¼ˆç·¨é›†å¯ï¼‰
          <input id="calloutCurrent" type="text" />
        </label>
        <div class="row" style="margin-top:10px;">
          <button id="btnModalApply" type="button">é©ç”¨</button>
          <button id="btnModalClear" type="button" class="ghost">ã‚¯ãƒªã‚¢</button>
        </div>
      </div>
    </div>
    <div style="margin-top:12px;" class="calloutList" id="calloutList"></div>
  </div>
</dialog>

<dialog id="pasteModal">
  <div class="modalHead">
    <div style="font-weight:900;">JSONã‚’è²¼ã‚Šä»˜ã‘ã¦èª­è¾¼</div>
    <button id="btnPasteClose" class="ghost" type="button">é–‰ã˜ã‚‹</button>
  </div>
  <div class="modalBody">
    <label>JSON
      <textarea id="pasteText" placeholder='{ "meta": {...}, "blocks": [ ... ] }'></textarea>
    </label>
    <div class="row" style="margin-top:10px;">
      <button id="btnPasteLoad" type="button">èª­è¾¼</button>
      <button id="btnPasteClear" type="button" class="ghost">ã‚¯ãƒªã‚¢</button>
    </div>
  </div>
</dialog>

<script>
const MAPS = [{"slug": "abyss", "ja": "ã‚¢ãƒ“ã‚¹", "en": "Abyss"}, {"slug": "ascent", "ja": "ã‚¢ã‚»ãƒ³ãƒˆ", "en": "Ascent"}, {"slug": "basic-training", "ja": "åŸºæœ¬ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°", "en": "Basic Training"}, {"slug": "bind", "ja": "ãƒã‚¤ãƒ³ãƒ‰", "en": "Bind"}, {"slug": "breeze", "ja": "ãƒ–ãƒªãƒ¼ã‚º", "en": "Breeze"}, {"slug": "corrode", "ja": "ã‚«ãƒ­ãƒ¼ãƒ‰", "en": "Corrode"}, {"slug": "district", "ja": "ãƒ‡ã‚£ã‚¹ãƒˆãƒªã‚¯ãƒˆ", "en": "District"}, {"slug": "drift", "ja": "ãƒ‰ãƒªãƒ•ãƒˆ", "en": "Drift"}, {"slug": "fracture", "ja": "ãƒ•ãƒ©ã‚¯ãƒãƒ£ãƒ¼", "en": "Fracture"}, {"slug": "glitch", "ja": "ã‚°ãƒªãƒƒãƒ", "en": "Glitch"}, {"slug": "haven", "ja": "ãƒ˜ã‚¤ãƒ´ãƒ³", "en": "Haven"}, {"slug": "icebox", "ja": "ã‚¢ã‚¤ã‚¹ãƒœãƒƒã‚¯ã‚¹", "en": "Icebox"}, {"slug": "kasbah", "ja": "ã‚«ã‚¹ãƒ", "en": "Kasbah"}, {"slug": "lotus", "ja": "ãƒ­ãƒ¼ã‚¿ã‚¹", "en": "Lotus"}, {"slug": "pearl", "ja": "ãƒ‘ãƒ¼ãƒ«", "en": "Pearl"}, {"slug": "piazza", "ja": "ãƒ”ã‚¢ãƒƒãƒ„ã‚¡", "en": "Piazza"}, {"slug": "skirmish-a", "ja": "ã‚¹ã‚«ãƒ¼ãƒŸãƒƒã‚·ãƒ¥ A", "en": "Skirmish A"}, {"slug": "skirmish-b", "ja": "ã‚¹ã‚«ãƒ¼ãƒŸãƒƒã‚·ãƒ¥ B", "en": "Skirmish B"}, {"slug": "skirmish-c", "ja": "ã‚¹ã‚«ãƒ¼ãƒŸãƒƒã‚·ãƒ¥ C", "en": "Skirmish C"}, {"slug": "split", "ja": "ã‚¹ãƒ—ãƒªãƒƒãƒˆ", "en": "Split"}, {"slug": "sunset", "ja": "ã‚µãƒ³ã‚»ãƒƒãƒˆ", "en": "Sunset"}, {"slug": "the-range", "ja": "å°„æ’ƒå ´", "en": "The Range"}, {"slug": "the-range", "ja": "å°„æ’ƒå ´", "en": "The Range"}];
const CALLOUTS_BY_SLUG = {"ascent": ["A ãƒ„ãƒªãƒ¼", "A ãƒ­ãƒ“ãƒ¼", "A ãƒ¡ã‚¤ãƒ³", "A ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦", "A ã‚µã‚¤ãƒˆ", "ã‚¢ã‚¿ãƒƒã‚¯å´ ã‚¹ãƒãƒ¼ãƒ³", "B ãƒ­ãƒ“ãƒ¼", "B ãƒ¡ã‚¤ãƒ³", "B ãƒœãƒ¼ãƒˆãƒã‚¦ã‚¹", "ä¸­å¤® ãƒœãƒˆãƒ ", "B ã‚µã‚¤ãƒˆ", "ä¸­å¤® ã‚­ãƒ£ãƒƒãƒˆã‚¦ã‚©ãƒ¼ã‚¯", "ä¸­å¤® å°éƒ¨å±‹", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ã‚¹ãƒãƒ¼ãƒ³", "A ã‚¬ãƒ¼ãƒ‡ãƒ³", "ä¸­å¤® ãƒãƒ¼ã‚±ãƒƒãƒˆ", "ä¸­å¤® ã‚³ãƒ¼ãƒˆãƒ¤ãƒ¼ãƒ‰", "ä¸­å¤® ãƒªãƒ³ã‚¯", "ä¸­å¤® ãƒ”ã‚¶", "A ãƒ©ãƒ•ã‚¿ãƒ¼", "ä¸­å¤® ãƒˆãƒƒãƒ—", "A ãƒ¯ã‚¤ãƒ³"], "split": ["A ãƒãƒƒã‚¯", "A ãƒ­ãƒ“ãƒ¼", "A ãƒ¡ã‚¤ãƒ³", "A ãƒ©ãƒ•ã‚¿ãƒ¼", "A ã‚¹ãƒ­ãƒ¼ãƒ—", "A ã‚¹ã‚¯ãƒªãƒ¼ãƒ³", "A ä¸‹æ°´é“", "A ã‚µã‚¤ãƒˆ", "A ã‚¿ãƒ¯ãƒ¼", "ã‚¢ã‚¿ãƒƒã‚¯å´ ã‚¹ãƒãƒ¼ãƒ³", "B è·¯åœ°", "B ãƒãƒƒã‚¯", "B ãƒªãƒ³ã‚¯", "B ã‚¬ãƒ¬ãƒ¼ã‚¸", "B ãƒ©ãƒ•ã‚¿ãƒ¼", "B ã‚µã‚¤ãƒˆ", "B éšæ®µ", "B ã‚¿ãƒ¯ãƒ¼", "B ãƒ­ãƒ“ãƒ¼", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ã‚¹ãƒãƒ¼ãƒ³", "ä¸­å¤® ãƒœãƒˆãƒ ", "ä¸­å¤® ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹", "ä¸­å¤® ãƒˆãƒƒãƒ—", "ä¸­å¤® ãƒ™ãƒ³ãƒˆ"], "fracture": ["ã‚¢ã‚¿ãƒƒã‚¯å´ ãƒ–ãƒªãƒƒã‚¸", "B ãƒ™ãƒ³ãƒ", "B ã‚¢ãƒ¼ã‚±ãƒ¼ãƒ‰", "B ã‚¿ãƒ¯ãƒ¼", "B ã‚µã‚¤ãƒˆ", "B ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼", "B ãƒªãƒ³ã‚¯", "B ã‚«ãƒ³ãƒ†ã‚£ãƒ¼ãƒ³", "A ãƒªãƒ³ã‚¯", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ã‚¹ãƒãƒ¼ãƒ³", "B ãƒ¡ã‚¤ãƒ³", "B ãƒ„ãƒªãƒ¼", "B ãƒˆãƒ³ãƒãƒ«", "A ãƒ›ãƒ¼ãƒ«", "A ãƒ‰ã‚¢", "A ãƒ­ãƒ¼ãƒ—", "A ãƒ¡ã‚¤ãƒ³", "A ã‚µã‚¤ãƒˆ", "A ãƒ‰ãƒ­ãƒƒãƒ—", "A ãƒ‘ãƒ©ãƒœãƒ©", "A ã‚²ãƒ¼ãƒˆ", "ã‚¢ã‚¿ãƒƒã‚¯å´ ã‚¹ãƒãƒ¼ãƒ³"], "bind": ["A å‡ºå£", "A ãƒªãƒ³ã‚¯", "A ãƒ­ãƒ“ãƒ¼", "A ã‚·ãƒ§ãƒ¼ãƒˆ", "A ã‚µã‚¤ãƒˆ", "A ãƒ†ãƒ¬ãƒãƒ¼ã‚¿ãƒ¼", "ã‚¢ã‚¿ãƒƒã‚¯å´ ã‚¹ãƒãƒ¼ãƒ³", "B å‡ºå£", "B ãƒ›ãƒ¼ãƒ«", "B ãƒªãƒ³ã‚¯", "B ãƒ•ã‚¡ã‚¦ãƒ³ãƒ†ãƒ³", "B ãƒ­ãƒ³ã‚°", "B ã‚·ãƒ§ãƒ¼ãƒˆ", "B ã‚µã‚¤ãƒˆ", "B ãƒ†ãƒ¬ãƒãƒ¼ã‚¿ãƒ¼", "B ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦", "A æµ´å ´", "ã‚¢ã‚¿ãƒƒã‚¯å´ ã‚±ã‚¤ãƒ´", "A å°éƒ¨å±‹", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ã‚¹ãƒãƒ¼ãƒ³", "B ã‚¨ãƒ«ãƒœãƒ¼", "B ã‚¬ãƒ¼ãƒ‡ãƒ³", "A ãƒ©ãƒ³ãƒ—", "A ã‚¿ãƒ¯ãƒ¼"], "breeze": ["A ãƒ›ãƒ¼ãƒ«", "A ãƒ–ãƒªãƒƒã‚¸", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ã‚¹ãƒãƒ¼ãƒ³", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ã‚¢ãƒ¼ãƒ", "ä¸­å¤® ã‚¦ãƒƒãƒ‰ãƒ‰ã‚¢", "ä¸­å¤® ãƒ”ãƒ©ãƒ¼", "ä¸­å¤® ãƒˆãƒƒãƒ—", "ä¸­å¤® ãƒã‚¹ãƒˆ", "B ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦", "B ãƒ¡ã‚¤ãƒ³", "ã‚¢ã‚¿ãƒƒã‚¯å´ ã‚¹ãƒãƒ¼ã‚¯", "B ã‚¨ãƒ«ãƒœãƒ¼", "B ã‚µã‚¤ãƒˆ", "B ãƒˆãƒ³ãƒãƒ«", "A ã‚¹ã‚¤ãƒƒãƒ", "ä¸­å¤® ã‚·ãƒ¥ãƒ¼ãƒˆ", "B ãƒãƒƒã‚¯", "B ã‚¦ã‚©ãƒ¼ãƒ«", "A ãƒ­ãƒ¼ãƒ—", "ä¸­å¤® ã‚­ãƒ£ãƒãƒ³", "A ãƒ¡ã‚¿ãƒ«ãƒ‰ã‚¢", "ä¸­å¤® ãƒœãƒˆãƒ ", "A ãƒ­ãƒ“ãƒ¼", "A ã‚·ãƒ§ãƒƒãƒ—", "A ã‚µã‚¤ãƒˆ", "A ãƒ”ãƒ©ãƒŸãƒƒãƒ‰", "ã‚¢ã‚¿ãƒƒã‚¯å´ ã‚¹ãƒãƒ¼ãƒ³"], "district": ["ã‚¢ã‚¿ãƒƒã‚¯å´ ãƒœãƒƒã‚¯ã‚¹", "ã‚¢ã‚¿ãƒƒã‚¯å´ ãƒã‚¹ãƒˆ", "ã‚¢ã‚¿ãƒƒã‚¯å´ ã‚¹ãƒãƒ¼ãƒ³", "ã‚¢ã‚¿ãƒƒã‚¯å´ éšæ®µ", "ã‚¢ã‚¿ãƒƒã‚¯å´ ã‚¦ã‚©ãƒ¼ãƒ«", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ãƒœãƒƒã‚¯ã‚¹", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ãƒã‚¹ãƒˆ", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ã‚¹ãƒãƒ¼ãƒ³", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ éšæ®µ", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ã‚¦ã‚©ãƒ¼ãƒ«", "ä¸­å¤® ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼", "ä¸­å¤® ãƒ›ãƒ¼ã‚¹ã‚·ãƒ¥ãƒ¼", "ä¸­å¤® ä¸‹æ°´é“"], "kasbah": ["ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ã‚¹ãƒãƒ¼ãƒ³", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ã‚¢ãƒ³ã‚°ãƒ«ãƒœãƒƒã‚¯ã‚¹", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ãƒªãƒ³ã‚¯", "ä¸­å¤® ãƒ”ãƒƒãƒˆ", "ä¸­å¤® ã‚¿ãƒ¯ãƒ¼", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ã‚¹ãƒ­ãƒ¼ãƒ—", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ãƒ•ãƒ©ãƒƒãƒˆãƒœãƒƒã‚¯ã‚¹", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ãƒã‚¹ãƒˆ", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ãƒˆãƒ³ãƒãƒ«", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦", "ã‚¢ã‚¿ãƒƒã‚¯å´ ã‚¹ãƒãƒ¼ãƒ³", "ã‚¢ã‚¿ãƒƒã‚¯å´ ã‚¢ãƒ³ã‚°ãƒ«ãƒœãƒƒã‚¯ã‚¹", "ã‚¢ã‚¿ãƒƒã‚¯å´ ãƒªãƒ³ã‚¯", "ã‚¢ã‚¿ãƒƒã‚¯å´ ã‚¹ãƒ­ãƒ¼ãƒ—", "ã‚¢ã‚¿ãƒƒã‚¯å´ ãƒ•ãƒ©ãƒƒãƒˆãƒœãƒƒã‚¯ã‚¹", "ã‚¢ã‚¿ãƒƒã‚¯å´ ãƒã‚¹ãƒˆ", "ã‚¢ã‚¿ãƒƒã‚¯å´ ãƒˆãƒ³ãƒãƒ«", "ã‚¢ã‚¿ãƒƒã‚¯å´ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦"], "drift": ["ã‚¢ã‚¿ãƒƒã‚¯å´ è·¯åœ°", "ã‚¢ã‚¿ãƒƒã‚¯å´ ãƒã‚¹ãƒˆ", "ã‚¢ã‚¿ãƒƒã‚¯å´ ã‚¹ãƒãƒ¼ãƒ³", "ã‚¢ã‚¿ãƒƒã‚¯å´ ã‚¿ãƒ¯ãƒ¼", "ã‚¢ã‚¿ãƒƒã‚¯å´ ãƒ¤ãƒ¼ãƒ‰", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ è·¯åœ°", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ãƒã‚¹ãƒˆ", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ã‚¹ãƒãƒ¼ãƒ³", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ã‚¿ãƒ¯ãƒ¼", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ãƒ¤ãƒ¼ãƒ‰", "ä¸­å¤® ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼"], "abyss": ["A ãƒ–ãƒªãƒƒã‚¸", "A ãƒªãƒ³ã‚¯", "A ãƒ­ãƒ“ãƒ¼", "A ãƒ¡ã‚¤ãƒ³", "A ã‚µã‚¤ãƒˆ", "ã‚¢ã‚¿ãƒƒã‚¯å´ ã‚¹ãƒãƒ¼ãƒ³", "A ã‚¿ãƒ¯ãƒ¼", "ä¸­å¤® ãƒ™ãƒ³ãƒ‰", "B ãƒªãƒ³ã‚¯", "B ãƒ­ãƒ“ãƒ¼", "B ãƒ¡ã‚¤ãƒ³", "B ãƒã‚¹ãƒˆ", "ä¸­å¤® ãƒœãƒˆãƒ ", "B ã‚µã‚¤ãƒˆ", "ä¸­å¤® ã‚­ãƒ£ãƒƒãƒˆã‚¦ã‚©ãƒ¼ã‚¯", "B ãƒ‡ãƒ³ã‚¸ãƒ£ãƒ¼", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ã‚¹ãƒãƒ¼ãƒ³", "ä¸­å¤® ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼", "A ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ", "A ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼", "ä¸­å¤® ãƒˆãƒƒãƒ—", "B ã‚¿ãƒ¯ãƒ¼", "A æ›æ°—é€šè·¯"], "lotus": ["A ãƒˆãƒƒãƒ—", "A ãƒ‰ãƒ­ãƒƒãƒ—", "A ã‚µã‚¤ãƒˆ", "A å°å±‹", "A ãƒ„ãƒªãƒ¼", "A æ‰‰", "A ãƒ¡ã‚¤ãƒ³", "A ãŒã‚Œã", "A ãƒ«ãƒ¼ãƒˆ", "A ãƒ­ãƒ“ãƒ¼", "C ãƒ­ãƒ“ãƒ¼", "B ãƒ”ãƒ©ãƒ¼", "B ãƒ¡ã‚¤ãƒ³", "C æ‰‰", "B ã‚µã‚¤ãƒˆ", "A ãƒªãƒ³ã‚¯", "B ã‚¢ãƒƒãƒ‘ãƒ¼", "C æ»", "C ãƒªãƒ³ã‚¯", "A éšæ®µ", "C ãƒã‚¦ãƒ³ãƒ‰", "C ãƒ¡ã‚¤ãƒ³", "C ãƒ™ãƒ³ãƒ‰", "C ã‚µã‚¤ãƒˆ", "C ãƒ›ãƒ¼ãƒ«", "C ç ‚åˆ©é“", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ã‚¹ãƒãƒ¼ãƒ³", "ã‚¢ã‚¿ãƒƒã‚¯å´ ã‚¹ãƒãƒ¼ãƒ³"], "sunset": ["B ã‚¿ãƒ”ã‚ªã‚«", "ä¸­å¤® ã‚¿ã‚¤ãƒ«", "B ãƒãƒ¼ã‚±ãƒƒãƒˆ", "B ã‚µã‚¤ãƒˆ", "B ãƒ¡ã‚¤ãƒ³", "B ãƒ­ãƒ“ãƒ¼", "ä¸­å¤® ãƒœãƒˆãƒ ", "ä¸­å¤® ã‚³ãƒ¼ãƒˆãƒ¤ãƒ¼ãƒ‰", "A ãƒ­ãƒ“ãƒ¼", "A ãƒ¡ã‚¤ãƒ³", "A ãƒªãƒ³ã‚¯", "A ã‚µã‚¤ãƒˆ", "A ã‚¨ãƒ«ãƒœãƒ¼", "A è·¯åœ°", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ã‚¹ãƒãƒ¼ãƒ³", "ä¸­å¤® ãƒˆãƒƒãƒ—", "ã‚¢ã‚¿ãƒƒã‚¯å´ ã‚¹ãƒãƒ¼ãƒ³"], "pearl": ["B ãƒ›ãƒ¼ãƒ«", "ä¸­å¤® ãƒ‰ã‚¢", "ä¸­å¤® ã‚³ãƒã‚¯ã‚¿ãƒ¼", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ã‚¹ãƒãƒ¼ãƒ³", "A ãƒ•ãƒ©ãƒ¯ãƒ¼", "A ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ", "A ãƒ€ã‚°ã‚¢ã‚¦ãƒˆ", "A ã‚µã‚¤ãƒˆ", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ãƒ¬ã‚³ãƒ¼ãƒ‰", "ä¸­å¤® ãƒˆãƒƒãƒ—", "B ãƒˆãƒ³ãƒãƒ«", "B ã‚¿ãƒ¯ãƒ¼", "A ãƒ¡ã‚¤ãƒ³", "A ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³", "B ãƒªãƒ³ã‚¯", "A ã‚¢ãƒ¼ãƒˆ", "A ãƒªãƒ³ã‚¯", "ä¸­å¤® ãƒ—ãƒ©ã‚¶", "ä¸­å¤® ã‚·ãƒ§ãƒƒãƒ—", "B ã‚¯ãƒ©ãƒ–", "B ã‚¹ãƒ­ãƒ¼ãƒ—", "B ãƒ¡ã‚¤ãƒ³", "B ã‚µã‚¤ãƒˆ", "B ã‚¹ã‚¯ãƒªãƒ¼ãƒ³", "ã‚¢ã‚¿ãƒƒã‚¯å´ ã‚¹ãƒãƒ¼ãƒ³"], "icebox": ["B ã‚¬ãƒ¬ãƒ¼ã‚¸", "A ãƒ™ãƒ«ãƒˆ", "A ãƒã‚¹ãƒˆ", "A ãƒ‘ã‚¤ãƒ—", "A ãƒ©ãƒ•ã‚¿ãƒ¼", "A ã‚¹ã‚¯ãƒªãƒ¼ãƒ³", "A ã‚µã‚¤ãƒˆ", "ã‚¢ã‚¿ãƒƒã‚¯å´ ã‚¹ãƒãƒ¼ãƒ³", "B ã‚¤ã‚¨ãƒ­ãƒ¼", "B ãƒãƒƒã‚¯", "B å°éƒ¨å±‹", "B ã‚°ãƒªãƒ¼ãƒ³", "B ãƒ›ãƒ¼ãƒ«", "B å°å±‹", "B ã‚­ãƒƒãƒãƒ³", "B ã‚ªãƒ¬ãƒ³ã‚¸", "B ã‚µã‚¤ãƒˆ", "B é›ªã ã‚‹ã¾", "B å †é›ªå ´", "B ãƒãƒ¥ãƒ¼ãƒ–", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ã‚¹ãƒãƒ¼ãƒ³", "ä¸­å¤® ãƒ–ãƒ«ãƒ¼", "ä¸­å¤® ãƒœã‚¤ãƒ©ãƒ¼", "ä¸­å¤® ãƒ‘ãƒ¬ãƒƒãƒˆ", "B ãƒ•ã‚§ãƒ³ã‚¹"], "corrode": ["A ã‚¯ãƒ¬ãƒ¼ãƒ³", "A ã‚¨ãƒ«ãƒœãƒ¼", "A ãƒªãƒ³ã‚¯", "A ãƒ­ãƒ“ãƒ¼", "A ãƒ¡ã‚¤ãƒ³", "A ãƒã‚±ãƒƒãƒˆ", "A ã‚µã‚¤ãƒˆ", "ã‚¢ã‚¿ãƒƒã‚¯å´ ã‚¹ãƒãƒ¼ãƒ³", "A ãƒ¤ãƒ¼ãƒ‰", "B ã‚¢ãƒ¼ãƒ", "B ã‚¨ãƒ«ãƒœãƒ¼", "B ãƒªãƒ³ã‚¯", "B ãƒ­ãƒ“ãƒ¼", "B ãƒ¡ã‚¤ãƒ³", "ä¸­å¤® ãƒœãƒˆãƒ ", "B ã‚µã‚¤ãƒˆ", "B ã‚¿ãƒ¯ãƒ¼", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ã‚¹ãƒãƒ¼ãƒ³", "ä¸­å¤® éšæ®µ", "ä¸­å¤® ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦", "ä¸­å¤® ãƒˆãƒƒãƒ—"], "haven": ["A ã‚¬ãƒ¼ãƒ‡ãƒ³", "A ãƒªãƒ³ã‚¯", "A ãƒ­ãƒ“ãƒ¼", "A ãƒ­ãƒ³ã‚°", "A ä¸‹æ°´é“", "A ã‚µã‚¤ãƒˆ", "ã‚¢ã‚¿ãƒƒã‚¯å´ ã‚¹ãƒãƒ¼ãƒ³", "B ãƒãƒƒã‚¯", "B ã‚µã‚¤ãƒˆ", "C ãƒªãƒ³ã‚¯", "C ãƒ­ãƒ“ãƒ¼", "C ãƒ­ãƒ³ã‚°", "C ã‚¬ãƒ¬ãƒ¼ã‚¸", "C ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦", "C ã‚µã‚¤ãƒˆ", "C å°éƒ¨å±‹", "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹å´ ã‚¹ãƒãƒ¼ãƒ³", "ä¸­å¤® ãƒ‰ã‚¢", "ä¸­å¤® ã‚³ãƒ¼ãƒˆãƒ¤ãƒ¼ãƒ‰", "ä¸­å¤® ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦", "A ã‚¿ãƒ¯ãƒ¼"]};

const SESSION_KEY = "shooting_sheet_editor_best_v1";
const $ = (id) => document.getElementById(id);

const ENUM_FORMAT = new Set(["short","long"]);

let state = {
  meta: {
    title: "",
    format: "short",
    map: "",
    map_slug: "",
    created_at: ""
  },
  blocks: []
};

let ui = {
  perCardSavedAt: [],
  perCardDirty: [],
  perCardCollapsed: []
};

let modal = {
  targetCardIndex: null
};

function nowISO(){ return new Date().toISOString(); }
function setStatus(kind, text){
  const dot = $("dot");
  dot.className = "dot" + (kind ? (" " + kind) : "");
  $("statusText").textContent = text;
}

function mapDisplay(m){ return (m.en || m.ja || m.slug); }

function sanitizeText(s){ return (s ?? "").toString(); }

function loadMapsSelect(){
  const sel = $("metaMap");
  sel.innerHTML = "";
  // placeholder
  const ph = document.createElement("option");
  ph.value = "";
  ph.textContent = "é¸æŠã—ã¦ãã ã•ã„";
  sel.appendChild(ph);

  for (const m of MAPS) {
    const opt = document.createElement("option");
    opt.value = m.slug;
    opt.textContent = `${mapDisplay(m)} (${m.slug})`;
    sel.appendChild(opt);
  }
}

function resolveMapInput(raw){
  const v = sanitizeText(raw).trim();
  if (!v) return { ok:false, slug:"", name:"" };

  // 1) slugä¸€è‡´
  const bySlug = MAPS.find(m => (m.slug || "").toLowerCase() === v.toLowerCase());
  if (bySlug) return { ok:true, slug: bySlug.slug, name: mapDisplay(bySlug) };

  // 2) nameä¸€è‡´
  const byName = MAPS.find(m => mapDisplay(m).toLowerCase() === v.toLowerCase());
  if (byName) return { ok:true, slug: byName.slug, name: mapDisplay(byName) };

  return { ok:false, slug:v, name:v };
}

function calloutsFor(slug){ return CALLOUTS_BY_SLUG[slug] || []; }

function ensureDefaults(){
  if (!state.meta.created_at) state.meta.created_at = nowISO();
  if (!state.meta.map_slug) {
    const haven = MAPS.find(m => m.slug === "haven");
    state.meta.map_slug = haven ? "haven" : (MAPS[0]?.slug || "");
  }
  if (!state.meta.map) {
    const m = MAPS.find(x => x.slug === state.meta.map_slug);
    state.meta.map = m ? mapDisplay(m) : state.meta.map_slug;
  }
  if (!state.meta.format) state.meta.format = "short";
}

function syncMetaToUI(){
  $("metaTitle").value = state.meta.title || "";
  $("metaFormat").value = state.meta.format || "short";
  $("metaMap").value = state.meta.map_slug || "";
  $("metaCreatedAt").textContent = state.meta.created_at || "-";
  updateResolvedLabel();
}

function normalizeFormat(){
  const v = sanitizeText($("metaFormat").value).trim().toLowerCase();
  const next = v || "short";
  $("metaFormat").value = next;
  return next;
}

function syncMetaFromUI(){
  state.meta.title = sanitizeText($("metaTitle").value).trim();
  state.meta.format = normalizeFormat();

  const slug = sanitizeText($("metaMap").value).trim();
  state.meta.map_slug = slug;

  const m = MAPS.find(x => x.slug === slug);
  state.meta.map = m ? mapDisplay(m) : "";

  if (!state.meta.created_at) state.meta.created_at = nowISO();
  updateResolvedLabel();
}

function updateResolvedLabel(){
  const slug = sanitizeText(state.meta.map_slug).trim();
  const m = MAPS.find(x => x.slug === slug);
  if (m) {
    $("mapResolved").textContent = `${mapDisplay(m)} (${m.slug})`;
  } else {
    $("mapResolved").textContent = slug ? `æœªé¸æŠ/ä¸æ­£ (${slug})` : "-";
  }
}

function newEmptyBlock(){
  return { script:"", premise:"", movement:"", location:"" };
}

function ensureUIArrays(){
  while (ui.perCardSavedAt.length < state.blocks.length) ui.perCardSavedAt.push(null);
  while (ui.perCardDirty.length < state.blocks.length) ui.perCardDirty.push(false);
  while (ui.perCardCollapsed.length < state.blocks.length) ui.perCardCollapsed.push(false);
}

function updateBlockFromUI(idx){
  const base = `b${idx}_`;
  state.blocks[idx] = {
    script: sanitizeText($(base+"script").value),
    premise: sanitizeText($(base+"premise").value),
    movement: sanitizeText($(base+"movement").value),
    location: sanitizeText($(base+"location").value),
  };
}

function setDirty(idx, dirty=true){
  ui.perCardDirty[idx] = dirty;
  renderBlockHeader(idx);
  renderCardList(); // å·¦ã®ãƒªã‚¹ãƒˆã‚‚åæ˜ 
  saveSession(true); // è‡ªå‹•å¾©å…ƒç”¨
}

function renderBlockHeader(idx){
  const dirtyEl = document.getElementById(`b${idx}_dirty`);
  const savedEl = document.getElementById(`b${idx}_saved`);
  if (dirtyEl) dirtyEl.textContent = ui.perCardDirty[idx] ? "æœªä¿å­˜" : "";
  if (savedEl) savedEl.textContent = ui.perCardSavedAt[idx] ? `ä¿å­˜:${ui.perCardSavedAt[idx]}` : "";
}

function cardTitleFromBlock(b){
  const first = sanitizeText(b.script).split(/\r?\n/).find(x => x.trim()) || "";
  return first.trim().slice(0, 60) || "(ç©º)";
}

function cardSubFromBlock(b){
  const loc = sanitizeText(b.location).trim();
  const p = sanitizeText(b.premise).trim();
  const m = sanitizeText(b.movement).trim();
  const bits = [];
  if (loc) bits.push("å ´æ‰€: " + loc);
  if (p) bits.push("å‰æ: " + p.split(/\r?\n/)[0].slice(0, 28));
  if (m) bits.push("å‹•ã: " + m.split(/\r?\n/)[0].slice(0, 28));
  return bits.join(" / ") || "-";
}

function isLocationValid(loc){
  const slug = sanitizeText(state.meta.map_slug).trim();
  const callouts = calloutsFor(slug);
  if (!loc.trim()) return false;
  if (!callouts.length) return true; // calloutsç„¡ã„å ´åˆã¯ç·©ã‚ã‚‹
  return callouts.includes(loc.trim());
}

function computeInvalidLocationIndices(){
  const slug = sanitizeText(state.meta.map_slug).trim();
  const callouts = calloutsFor(slug);
  const invalid = [];
  for (let i=0;i<state.blocks.length;i++){
    const loc = sanitizeText(state.blocks[i]?.location || "").trim();
    if (!loc) continue; // ç©ºã¯ã“ã“ã§ã¯å¯¾è±¡å¤–ï¼ˆValidationãŒæ‰±ã†ï¼‰
    if (callouts.length && !callouts.includes(loc)) invalid.push(i);
  }
  return invalid;
}

function updateMapFixBar(){
  const bar = $("mapFixBar");
  const cnt = $("mapFixCount");
  if (!bar || !cnt) return;
  const invalid = computeInvalidLocationIndices();
  cnt.textContent = String(invalid.length);
  bar.style.display = invalid.length ? "block" : "none";
}

function clearInvalidLocations(){
  const invalid = computeInvalidLocationIndices();
  if (!invalid.length) return;
  for (const idx of invalid){
    state.blocks[idx].location = "";
    ui.perCardDirty[idx] = true;
  }
  renderBlocks();
  renderCardList();
  saveSession(true);
  setStatus("warn","ä¸€æ‹¬ã‚¯ãƒªã‚¢");
  updateMapFixBar();
}

function jumpToFirstInvalid(){
  const invalid = computeInvalidLocationIndices();
  if (!invalid.length) return;
  const idx = invalid[0];
  const el = document.getElementById(`block_${idx}`);
  if (el) el.scrollIntoView({behavior:"smooth", block:"start"});
}

function renderCardList(){
  ensureUIArrays();
  const root = $("cardList");
  root.innerHTML = "";
  state.blocks.forEach((b, idx) => {
    const li = document.createElement("div");
    li.className = "listItem";
    li.draggable = true;
    li.dataset.idx = String(idx);

    const title = cardTitleFromBlock(b);
    const sub = cardSubFromBlock(b);
const dirty = ui.perCardDirty[idx];

    const invalidLoc = (() => { const loc = sanitizeText(b.location||"").trim(); return (loc && !isLocationValid(loc)); })();
    const badgeKind = dirty ? "warn" : (invalidLoc ? "ng" : "");
    const badgeText = dirty ? "EDIT" : (invalidLoc ? "!" : "");
li.innerHTML = `
      <div class="listLeft">
        <div class="listTop">
          <span class="badge ${badgeKind}">#${idx+1} ${badgeText}</span>
          <div class="listTitle" title="${title.replace(/"/g,'&quot;')}">${title.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>
        </div>
        <div class="listSub" title="${sub.replace(/"/g,'&quot;')}">${sub.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>
      </div>
      <div class="listRight">
        <button class="iconbtn ghost" type="button" data-act="jump" data-idx="${idx}">é–‹ã</button>
      </div>
    `;
    root.appendChild(li);
  });

  // jump handlers
  root.querySelectorAll('button[data-act="jump"]').forEach(btn => {
    btn.addEventListener("click", (ev) => {
      const idx = Number(btn.dataset.idx);
      const el = document.getElementById(`block_${idx}`);
      if (el) el.scrollIntoView({behavior:"smooth", block:"start"});
    });
  });

  // Drag reorder
  let dragSrc = null;
  root.querySelectorAll(".listItem").forEach(item => {
    item.addEventListener("dragstart", (ev) => {
      dragSrc = item;
      ev.dataTransfer.setData("text/plain", item.dataset.idx || "");
      ev.dataTransfer.effectAllowed = "move";
    });
    item.addEventListener("dragover", (ev) => {
      ev.preventDefault();
      ev.dataTransfer.dropEffect = "move";
      item.style.outline = "2px solid rgba(255,255,255,.12)";
      item.style.outlineOffset = "2px";
    });
    item.addEventListener("dragleave", () => {
      item.style.outline = "";
      item.style.outlineOffset = "";
    });
    item.addEventListener("drop", (ev) => {
      ev.preventDefault();
      item.style.outline = "";
      item.style.outlineOffset = "";
      const from = Number(ev.dataTransfer.getData("text/plain"));
      const to = Number(item.dataset.idx);
      if (Number.isNaN(from) || Number.isNaN(to) || from === to) return;
      moveCard(from, to);
    });
  });
}

function moveCard(from, to){
  const b = state.blocks.splice(from,1)[0];
  state.blocks.splice(to,0,b);

  const sa = ui.perCardSavedAt.splice(from,1)[0];
  ui.perCardSavedAt.splice(to,0,sa);

  const di = ui.perCardDirty.splice(from,1)[0];
  ui.perCardDirty.splice(to,0,di);

  const co = ui.perCardCollapsed.splice(from,1)[0];
  ui.perCardCollapsed.splice(to,0,co);

  renderBlocks();
  renderCardList();
  saveSession(true);
  setStatus("warn","ä¸¦ã³æ›¿ãˆ");
}

function renderBlocks(){
  syncMetaFromUI();
  ensureUIArrays();

  // callouts datalistï¼ˆå„ã‚«ãƒ¼ãƒ‰å…¥åŠ›è£œåŠ©ï¼‰
  const slug = sanitizeText(state.meta.map_slug).trim();
  const callouts = calloutsFor(slug);
  let dl = document.getElementById("calloutDatalist");
  if (!dl) {
    dl = document.createElement("datalist");
    dl.id = "calloutDatalist";
    document.body.appendChild(dl);
  }
  dl.innerHTML = "";
  for (const c of callouts) {
    const opt = document.createElement("option");
    opt.value = c;
    dl.appendChild(opt);
  }

  const root = $("blocks");
  root.innerHTML = "";

  state.blocks.forEach((b, idx) => {
    const el = document.createElement("div");
    el.className = "block";
    el.id = `block_${idx}`;

    const collapsed = ui.perCardCollapsed[idx] === true;
const collapseLabel = collapsed ? "å±•é–‹" : "æŠ˜ã‚ŠãŸãŸã¿";

    el.innerHTML = `
      <div class="blockHead">
        <div class="blockTitle">
          <span class="idx">#${idx+1}</span>
          <span id="b${idx}_dirty" class="dirty"></span>
          <span id="b${idx}_saved" class="stamp"></span>
          
        </div>
        <div class="row">
          <button class="iconbtn" type="button" data-act="save" data-idx="${idx}">ä¿å­˜</button>
          <button class="iconbtn ghost" type="button" data-act="dup" data-idx="${idx}">è¤‡è£½</button>
          <button class="iconbtn ghost" type="button" data-act="toggle" data-idx="${idx}">${collapseLabel}</button>
          <button class="iconbtn danger" type="button" data-act="del" data-idx="${idx}">å‰Šé™¤</button>
        </div>
      </div>

      <div class="content" style="display:${collapsed ? "none" : "block"}">
        <label>å°æœ¬
          <textarea id="b${idx}_script" placeholder="ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã®å°æœ¬ï¼ˆãã®ã¾ã¾ï¼‰"></textarea>
        </label>

        <div class="cols" style="margin-top:10px;">
          <label>å‰æ
            <textarea id="b${idx}_premise" placeholder="ä¾‹ï¼šå°‘äººæ•°æˆ¦/éŸ³ã§ãƒãƒ¬ã‚‹å‰æãªã©"></textarea>
          </label>
          <label>å‹•ãæ–¹
            <textarea id="b${idx}_movement" placeholder="ä¾‹ï¼šãƒªãƒ­ãƒ¼ãƒ‰éŸ³â†’æ•µãŒå¯„ã‚‹â†’æ’ƒã¦ãšã«è½ã¡ã‚‹ ãªã©"></textarea>
          </label>
        </div>

        <div class="locationBox">
          <label>ğŸ“ æ’®å½±å ´æ‰€
            <div class="locRow">
              <input id="b${idx}_location" type="text" list="calloutDatalist" placeholder="ä¾‹ï¼šA ãƒ­ãƒ³ã‚°" />
              <button class="iconbtn" type="button" data-act="pick" data-idx="${idx}">ğŸ“‹ å€™è£œã‹ã‚‰é¸ã¶</button>
            </div>
          </label>
        </div>
</div>
    `;
    root.appendChild(el);

    // å€¤åæ˜ 
    const sEl = document.getElementById(`b${idx}_script`);
    if (sEl) sEl.value = b.script || "";
    const pEl = document.getElementById(`b${idx}_premise`);
    if (pEl) pEl.value = b.premise || "";
    const mEl = document.getElementById(`b${idx}_movement`);
    if (mEl) mEl.value = b.movement || "";
    const lEl = document.getElementById(`b${idx}_location`);
    if (lEl) lEl.value = b.location || "";

    // å¤‰æ›´ç›£è¦–
    const onChange = () => setDirty(idx, true);
    if (sEl) sEl.addEventListener("input", onChange);
    if (pEl) pEl.addEventListener("input", onChange);
    if (mEl) mEl.addEventListener("input", onChange);
    if (lEl) lEl.addEventListener("input", onChange);

    renderBlockHeader(idx);
  });

  $("cardCount").textContent = String(state.blocks.length);
}

function validateState(showAlert=false){
  syncMetaFromUI();
  for (let i=0;i<state.blocks.length;i++) {
    const base = document.getElementById(`b${i}_script`);
    if (base) updateBlockFromUI(i);
  }

  const errs = [];
  const metaTitle = sanitizeText(state.meta.title).trim();
  if (!metaTitle) errs.push("meta.title ãŒç©ºã§ã™");
  const fmt = sanitizeText(state.meta.format).trim();
  if (!ENUM_FORMAT.has(fmt)) errs.push("meta.format ã¯ short/long ã®ã¿");
  const slug = sanitizeText(state.meta.map_slug).trim();
  if (!slug) errs.push("meta.map_slug ãŒç©ºã§ã™");
  const mapKnown = MAPS.find(m => m.slug === slug);
  if (!mapKnown) errs.push(`meta.map_slug ãŒæœªçŸ¥ã§ã™ï¼ˆ${slug}ï¼‰`);
  if (!Array.isArray(state.blocks) || state.blocks.length < 1) errs.push("blocks ãŒ1ä»¶ä»¥ä¸Šå¿…è¦ã§ã™");

  const callouts = calloutsFor(slug);
  state.blocks.forEach((b, idx) => {
    if (!sanitizeText(b.script).trim()) errs.push(`blocks[${idx+1}].script ãŒç©ºã§ã™`);
    const loc = sanitizeText(b.location).trim();
    if (!loc) errs.push(`blocks[${idx+1}].location ãŒç©ºã§ã™`);
    else if (callouts.length && !callouts.includes(loc)) errs.push(`blocks[${idx+1}].location ãŒcalloutså¤–: "${loc}"`);
  });

  const summary = errs.length === 0 ? "OK" : `NGï¼ˆ${errs.length}ä»¶ï¼‰`;
  $("validationSummary").textContent = summary;
  $("validationDetails").textContent = errs.length ? errs.join("\n") : "å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚";

  if (errs.length === 0) setStatus("ok", "æ¤œè¨¼OK");
  else setStatus("ng", "æ¤œè¨¼NG");

  renderCardList();
  renderBlocks(); // LOCãƒãƒƒã‚¸æ›´æ–°

  if (showAlert && errs.length) alert(errs.join("\n"));
  return errs;
}

function saveSession(isAuto=false){
  syncMetaFromUI();
  for (let i=0;i<state.blocks.length;i++) {
    const base = document.getElementById(`b${i}_script`);
    if (base) updateBlockFromUI(i);
  }
  const payload = JSON.stringify({ meta: state.meta, blocks: state.blocks, _ui: ui }, null, 2);
  sessionStorage.setItem(SESSION_KEY, payload);
  if (!isAuto) setStatus("ok", "ä¿å­˜");
}

function loadSession(){
  const raw = sessionStorage.getItem(SESSION_KEY);
  if (!raw) return false;
  try {
    const data = JSON.parse(raw);
    if (data && data.meta && Array.isArray(data.blocks)) {
      state.meta = data.meta;
      state.blocks = data.blocks;
      if (data._ui) ui = data._ui;
      return true;
    }
  } catch {}
  return false;
}

function exportJsonText(){
  const errs = validateState(false);
  if (errs.length) return null;
  const out = {
    meta: {
      title: state.meta.title,
      format: state.meta.format,
      map: state.meta.map,
      map_slug: state.meta.map_slug,
      created_at: state.meta.created_at
    },
    blocks: state.blocks
  };
  return JSON.stringify(out, null, 2);
}

function downloadText(filename, text){
  const blob = new Blob([text], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

function addCard(){
  state.blocks.push(newEmptyBlock());
  ui.perCardSavedAt.push(null);
  ui.perCardDirty.push(true);
  ui.perCardCollapsed.push(false);
  renderBlocks();
  renderCardList();
  saveSession(true);
  setStatus("warn","è¿½åŠ ");
  // scroll
  setTimeout(() => {
    const el = document.getElementById(`block_${state.blocks.length-1}`);
    if (el) el.scrollIntoView({behavior:"smooth", block:"start"});
  }, 50);
}

function duplicateCard(idx){
  const src = state.blocks[idx] || newEmptyBlock();
  const copy = JSON.parse(JSON.stringify(src));
  state.blocks.splice(idx+1, 0, copy);
  ui.perCardSavedAt.splice(idx+1, 0, null);
  ui.perCardDirty.splice(idx+1, 0, true);
  ui.perCardCollapsed.splice(idx+1, 0, false);
  renderBlocks();
  renderCardList();
  saveSession(true);
  setStatus("warn","è¤‡è£½");
}

function deleteCard(idx){
  const ok = confirm(`ã‚«ãƒ¼ãƒ‰ #${idx+1} ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`);
  if (!ok) return;
  state.blocks.splice(idx,1);
  ui.perCardSavedAt.splice(idx,1);
  ui.perCardDirty.splice(idx,1);
  ui.perCardCollapsed.splice(idx,1);
  renderBlocks();
  renderCardList();
  saveSession(true);
  setStatus("warn","å‰Šé™¤");
}

function saveCard(idx){
  updateBlockFromUI(idx);
  ui.perCardSavedAt[idx] = new Date().toLocaleString();
  ui.perCardDirty[idx] = false;
  saveSession(false);
  renderBlockHeader(idx);
  renderCardList();
}

function toggleCard(idx){
  ui.perCardCollapsed[idx] = !ui.perCardCollapsed[idx];
  renderBlocks();
  saveSession(true);
  setStatus("warn", ui.perCardCollapsed[idx] ? "æŠ˜ã‚ŠãŸãŸã¿" : "å±•é–‹");
}

function openCalloutModal(idx){
  syncMetaFromUI();
  const slug = sanitizeText(state.meta.map_slug).trim();
  const m = MAPS.find(x => x.slug === slug);
  $("modalMap").textContent = m ? `${mapDisplay(m)} (${slug})` : `UNKNOWN (${slug})`;

  const callouts = calloutsFor(slug);
  $("modalCount").textContent = String(callouts.length);

  modal.targetCardIndex = idx;
  const current = sanitizeText(state.blocks[idx]?.location || "").trim();
  $("calloutCurrent").value = current;
  $("calloutSearch").value = "";

  renderCalloutList(callouts);
  $("calloutModal").showModal();
  $("calloutSearch").focus();
}

function renderCalloutList(callouts){
  const q = sanitizeText($("calloutSearch").value).trim().toLowerCase();
  const list = $("calloutList");
  list.innerHTML = "";
  const filtered = q ? callouts.filter(x => x.toLowerCase().includes(q)) : callouts;
  for (const c of filtered) {
    const div = document.createElement("div");
    div.className = "calloutItem";
    div.textContent = c;
    div.addEventListener("click", () => {
      $("calloutCurrent").value = c;
      applyCalloutToCard();
    });
    list.appendChild(div);
  }
}

function applyCalloutToCard(){
  const idx = modal.targetCardIndex;
  if (idx === null || idx === undefined) return;
  const val = sanitizeText($("calloutCurrent").value).trim();
  // UIå´ã«åæ˜ 
  const input = document.getElementById(`b${idx}_location`);
  if (input) input.value = val;
  setDirty(idx, true);
  $("calloutModal").close();
}

function attachHandlers(){
  // meta
  $("metaTitle").addEventListener("input", () => saveSession(true));
  $("metaFormat").addEventListener("change", () => {
    syncMetaFromUI(); saveSession(true); setStatus("warn","formatå¤‰æ›´");
  });
  $("metaFormat").addEventListener("blur", () => {
    syncMetaFromUI(); saveSession(true);
  });
  $("metaMap").addEventListener("change", () => {
    syncMetaFromUI();
    renderBlocks();
    renderCardList();
    saveSession(true);
    setStatus("warn","mapå¤‰æ›´");
  });
// actions
  $("btnImport").addEventListener("click", async () => {
    const file = $("importFile").files?.[0];
    if (!file) { setStatus("ng","æœªé¸æŠ"); return; }
    try {
      const txt = await file.text();
      importFromJsonText(txt);
      setStatus("ok","èª­è¾¼");
    } catch {
      setStatus("ng","å¤±æ•—");
    }
  });

  $("btnValidate").addEventListener("click", () => validateState(true));

  $("btnExport").addEventListener("click", () => {
    const txt = exportJsonText();
    if (!txt) { validateState(true); return; }
    const safeTitle = (state.meta.title || "shooting_sheet").replace(/[^a-zA-Z0-9_\-]+/g,"_");
    downloadText(`${safeTitle}.json`, txt);
    setStatus("ok","å‡ºåŠ›");
  });

  $("btnCopy").addEventListener("click", async () => {
    const txt = exportJsonText();
    if (!txt) { validateState(true); return; }
    try {
      await navigator.clipboard.writeText(txt);
      setStatus("ok","ã‚³ãƒ”ãƒ¼");
    } catch {
      setStatus("ng","å¤±æ•—");
    }
  });

  $("btnPaste").addEventListener("click", () => {
    $("pasteText").value = "";
    $("pasteModal").showModal();
    setTimeout(() => $("pasteText").focus(), 50);
  });
  $("btnPasteClose").addEventListener("click", () => $("pasteModal").close());
  $("btnPasteClear").addEventListener("click", () => $("pasteText").value = "");
  $("btnPasteLoad").addEventListener("click", () => {
    const txt = sanitizeText($("pasteText").value);
    importFromJsonText(txt);
    $("pasteModal").close();
    setStatus("ok","èª­è¾¼");
  });

  $("btnClear").addEventListener("click", () => {
    const ok = confirm("ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
    if (!ok) return;
    sessionStorage.removeItem(SESSION_KEY);
    state = { meta: { title:"", format:"short", map:"", map_slug:"", created_at:"" }, blocks: [] };
    ui = { perCardSavedAt: [], perCardDirty: [], perCardCollapsed: [] };
    ensureDefaults();
    syncMetaToUI();
    renderBlocks();
    renderCardList();
    $("validationSummary").textContent = "-";
    $("validationDetails").textContent = "";
    setStatus("warn","å‰Šé™¤");
  });

  $("btnAddLeft").addEventListener("click", addCard);
  $("btnAddBottom").addEventListener("click", addCard);

  $("btnSaveAll").addEventListener("click", () => {
    for (let i=0;i<state.blocks.length;i++) {
      const base = document.getElementById(`b${i}_script`);
      if (base) updateBlockFromUI(i);
      ui.perCardSavedAt[i] = new Date().toLocaleString();
      ui.perCardDirty[i] = false;
    }
    saveSession(false);
    renderBlocks();
    renderCardList();
    setStatus("ok","ä¿å­˜");
  });

  // cards actions (event delegation)
  $("blocks").addEventListener("click", (ev) => {
    const btn = ev.target.closest("button[data-act]");
    if (!btn) return;
    const act = btn.dataset.act;
    const idx = Number(btn.dataset.idx);
    if (Number.isNaN(idx)) return;
    if (act === "save") return saveCard(idx);
    if (act === "dup") return duplicateCard(idx);
    if (act === "del") return deleteCard(idx);
    if (act === "toggle") return toggleCard(idx);
    if (act === "pick") return openCalloutModal(idx);
  });

  // modal
  $("btnModalClose").addEventListener("click", () => $("calloutModal").close());
  $("calloutSearch").addEventListener("input", () => {
    const slug = sanitizeText(state.meta.map_slug).trim();
    renderCalloutList(calloutsFor(slug));
  });
  $("btnModalApply").addEventListener("click", applyCalloutToCard);
  $("btnModalClear").addEventListener("click", () => $("calloutCurrent").value = "");

  // Keyboard shortcuts
  document.addEventListener("keydown", (ev) => {
    const isMac = navigator.platform.toLowerCase().includes("mac");
    const mod = isMac ? ev.metaKey : ev.ctrlKey;

    if (mod && ev.key.toLowerCase() === "s") {
      ev.preventDefault();
      $("btnSaveAll").click();
    }
    if (mod && ev.key === "Enter") {
      // active card save (nearest block)
      const active = document.activeElement;
      if (!active) return;
      const block = active.closest?.(".block");
      if (!block) return;
      const id = block.id || "";
      const m = id.match(/^block_(\d+)$/);
      if (!m) return;
      ev.preventDefault();
      const idx = Number(m[1]);
      if (!Number.isNaN(idx)) saveCard(idx);
    }
  });
}

function importFromJsonText(txt){
  try {
    const data = JSON.parse(txt);
    if (!data || !data.meta || !Array.isArray(data.blocks)) {
      alert("å½¢å¼ä¸æ­£ï¼šmeta/blocks ãŒå¿…è¦ã§ã™");
      return;
    }
    // meta
    state.meta.title = sanitizeText(data.meta.title).trim();
    state.meta.format = sanitizeText(data.meta.format).trim().toLowerCase() || "short";
    // map resolve: allow meta.map_slug / meta.map / top-level map_slug / map
    const rawMap = sanitizeText((data.meta.map_slug ?? data.meta.map ?? data.map_slug ?? data.map ?? "")).trim();
    const resolved = resolveMapInput(rawMap); // slug/ja/en/è¡¨ç¤ºå ã„ãšã‚Œã§ã‚‚è§£æ±º
    if (resolved.ok) {
      state.meta.map_slug = resolved.slug;
      const known = MAPS.find(m => m.slug === resolved.slug);
      state.meta.map = known ? mapDisplay(known) : resolved.name;
    } else {
      // å³æ ¼åŒ–ï¼šæœªçŸ¥ãƒãƒƒãƒ—ã¯é¸æŠã•ã›ç›´ã™
      state.meta.map_slug = "";
      state.meta.map = "";
      if (rawMap) alert("æœªçŸ¥ã® map ã§ã™ã€‚Map ã‚’é¸æŠã—ã¦ãã ã•ã„: " + rawMap);
    }
    state.meta.created_at = sanitizeText(data.meta.created_at || "").trim() || nowISO();
// blocks
    state.blocks = data.blocks.map(b => ({
      script: sanitizeText(b.script || ""),
      premise: sanitizeText(b.premise || ""),
      movement: sanitizeText(b.movement || ""),
      location: sanitizeText(b.location || ""),
    }));

    // ui reset
    ui.perCardSavedAt = new Array(state.blocks.length).fill(null);
    ui.perCardDirty = new Array(state.blocks.length).fill(false);
    ui.perCardCollapsed = new Array(state.blocks.length).fill(false);

    ensureDefaults();
    syncMetaToUI();
    renderBlocks();
    renderCardList();
    saveSession(true);
    validateState(false);
  } catch (e) {
    alert("JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
}

(function init(){
  loadMapsSelect();
  const restored = loadSession();
  ensureDefaults();
  syncMetaToUI();

  if (!state.blocks.length) {
    // åˆæœŸã‚«ãƒ¼ãƒ‰1æš
    state.blocks = [newEmptyBlock()];
    ui.perCardSavedAt = [null];
    ui.perCardDirty = [false];
    ui.perCardCollapsed = [false];
  }

  renderBlocks();
  renderCardList();
  attachHandlers();
  validateState(false);

  setStatus(restored ? "ok" : "", restored ? "å¾©å…ƒ" : "-");
})();
</script>
</body>
</html>
